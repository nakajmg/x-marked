<script src="marked.js"></script>
<template id="x-marked">
  <link rel="stylesheet" href="github-markdown.css">
  <style>
    :unresolved { display: none; }
    [data-x-marked-originalText] { display: none; }
  </style>
  <section class="x-marked">
    <div data-x-marked-content></div>
    <div data-x-marked-originalText>
      <content></content>
    </div>
  </section>
</template>

<script>
(function() {
  var currentScript = document._currentScript || document.currentScript;
  var doc = currentScript.ownerDocument;
  
  var proto = Object.create(HTMLElement.prototype, {
    createdCallback: {
      value: function() {
        var _this = this;
        var root = this.createShadowRoot();
        var tmpl = doc.querySelector('#x-marked');
        var clone = document.importNode(tmpl.content, true);
        this.createShadowRoot().appendChild(clone);
        this.applyStyle();
      }
    },
    applyStyle: {
      value: function() {
        var _this = this, style, cssHref, xhr;
        var isApplyStyle = this.hasAttribute('data-apply-style');
        
        if(isApplyStyle) {
          cssHref = this.shadowRoot.querySelector('link[rel=stylesheet]').getAttribute('href');
          xhr = new XMLHttpRequest();
          xhr.open('GET', cssHref, true);
          xhr.onload = function() {
            if (xhr.status === 200){
              style = document.createElement('style');
              style.textContent = xhr.responseText;
              _this.shadowRoot.appendChild(style);
              _this.shadowRoot.querySelector('[data-x-marked-content]').classList.add('markdown-body');
            }
          }
          xhr.send();
        }
      }
    },
    attachedCallback: {
      value: function() {
        var originalText = this.innerHTML;
        var markedContent = this.shadowRoot.querySelector('[data-x-marked-content]');
        markedContent.innerHTML = marked(originalText)
      }
    }
  });

  document.registerElement('x-marked', {prototype: proto});
})();
</script>
